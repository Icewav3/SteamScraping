# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ§ª TEST PIPELINE - Comprehensive Testing Workflow
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# NEW FILE - Dedicated testing workflow
#
# WHY: Enables rapid testing of entire pipeline without consuming resources.
#      Tests all code paths with minimal data (1 page scrape ~= 1 minute).
#
# Key Features:
# - Fast execution (1 page scrape)
# - Tests all pipeline phases
# - Validates merge logic
# - Checks data integrity
# - No release pollution (uses separate test tags)
# - Can be run on pull requests
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: ğŸ§ª Test Pipeline

on:
  workflow_dispatch:
    inputs:
      skip_download:
        description: 'Skip downloading previous data (for first-run testing)'
        required: false
        default: false
        type: boolean
      
      create_test_release:
        description: 'Create a test release (will be auto-deleted)'
        required: false
        default: false
        type: boolean
  
  pull_request:
    branches: [ main ]
    paths:
      - '.github/workflows/**'
      - 'src/**'
      - 'pyproject.toml'

env:
  DATA_DIR: 'Data'
  PYTHON_VERSION: '3.13'

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PHASE 0: DOWNLOAD PREVIOUS DATA (Optional)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  download-previous:
    name: ğŸ“¥ Download Previous Data
    if: ${{ github.event.inputs.skip_download != 'true' }}
    uses: ./.github/workflows/download-previous.yml
    secrets: inherit
  
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PHASE 1: SCRAPING (Test Mode - 1 Page Only)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  scrape-steamspy:
    name: ğŸ® SteamSpy Scraper (Test)
    needs: download-previous
    if: always() && !cancelled()
    uses: ./.github/workflows/scrape-steamspy.yml
    secrets: inherit
    with:
      pages: "1"           # Only 1 page for testing
      page_delay: "1"      # Fast delays
      app_delay: "0.05"    # Fast delays
      test_mode: true      # Enable test mode flag
  
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PHASE 2: COMPRESSION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  compress-data:
    name: ğŸ“¦ Compress Data (Test)
    needs: 
      - download-previous
      - scrape-steamspy
    if: always() && !cancelled()
    uses: ./.github/workflows/compress.yml
    secrets: inherit
  
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PHASE 3: VALIDATION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  validate-data:
    name: âœ… Validate Data (Test)
    needs: compress-data
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    outputs:
      validation_passed: ${{ steps.validate.outputs.passed }}
    
    steps:
      - name: ğŸ“¥ Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: archive-metadata
          path: ./
      
      - name: ğŸ“¥ Download Archive
        uses: actions/download-artifact@v4
        with:
          name: compressed-data-archive
          path: ./archive/
      
      - name: ğŸ” Validate Archive
        id: validate
        run: |
          echo "ğŸ” Validating test archive..."
          
          # Check metadata
          if [ ! -f "archive-metadata.json" ]; then
            echo "âŒ Metadata missing"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Parse metadata
          TOTAL=$(jq -r '.total_entries' archive-metadata.json)
          NEW=$(jq -r '.new_entries' archive-metadata.json)
          
          echo "ğŸ“Š Test Results:"
          echo "  â€¢ Total entries: $TOTAL"
          echo "  â€¢ New entries: $NEW"
          
          # Find archive
          ARCHIVE=$(find ./archive -name "*.tar.gz" | head -1)
          
          if [ -z "$ARCHIVE" ]; then
            echo "âŒ Archive not found"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Test extraction
          echo "ğŸ“¦ Testing archive extraction..."
          mkdir -p test_extract
          if tar -xzf "$ARCHIVE" -C test_extract; then
            echo "âœ… Archive extracts successfully"
          else
            echo "âŒ Archive extraction failed"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Verify JSONL files
          JSONL_COUNT=$(find test_extract -name "*.jsonl" | wc -l)
          echo "ğŸ“„ Found $JSONL_COUNT JSONL files"
          
          if [ "$JSONL_COUNT" -eq 0 ]; then
            echo "âŒ No JSONL files in archive"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Test JSONL format
          FIRST_JSONL=$(find test_extract -name "*.jsonl" | head -1)
          if head -n 1 "$FIRST_JSONL" | python3 -m json.tool > /dev/null 2>&1; then
            echo "âœ… JSONL format is valid"
          else
            echo "âŒ Invalid JSONL format"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Check for reasonable data
          if [ "$TOTAL" -gt 0 ] && [ "$TOTAL" -le 1100 ]; then
            echo "âœ… Test data within expected range (1-1100 entries)"
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Unexpected entry count: $TOTAL"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: ğŸ“Š Generate Test Report
        if: always()
        run: |
          echo "## ğŸ§ª Test Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.validate.outputs.passed }}" == "true" ]; then
            echo "âœ… **Status:** PASSED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All test validations passed successfully!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status:** FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Test validation failed. Check logs above." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "archive-metadata.json" ]; then
            echo "### ğŸ“Š Test Statistics" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Total Entries | $(jq -r '.total_entries' archive-metadata.json) |" >> $GITHUB_STEP_SUMMARY
            echo "| New Entries | $(jq -r '.new_entries' archive-metadata.json) |" >> $GITHUB_STEP_SUMMARY
            echo "| Previous Entries | $(jq -r '.previous_entries' archive-metadata.json) |" >> $GITHUB_STEP_SUMMARY
            echo "| Archive Size | $(jq -r '.compressed_size_mb' archive-metadata.json) |" >> $GITHUB_STEP_SUMMARY
          fi
  
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PHASE 4: OPTIONAL TEST RELEASE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  create-test-release:
    name: ğŸ§ª Create Test Release
    if: ${{ github.event.inputs.create_test_release == 'true' }}
    needs: validate-data
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: write
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ“¥ Download Archive
        uses: actions/download-artifact@v4
        with:
          name: compressed-data-archive
          path: ./artifacts/
      
      - name: ğŸ·ï¸ Create Test Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TEST_TAG="test-$(date +%Y%m%d-%H%M%S)"
          
          echo "ğŸ·ï¸ Creating test release: $TEST_TAG"
          
          # Create release notes
          cat > release-notes.md << EOF
          # ğŸ§ª Test Release
          
          **âš ï¸ This is a test release and will be automatically deleted**
          
          - Created: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - Workflow: ${{ github.run_id }}
          - Test mode: 1 page scrape
          
          This release tests the complete pipeline workflow.
          EOF
          
          # Create release
          gh release create "$TEST_TAG" \
            --title "Test Release - $TEST_TAG" \
            --notes-file release-notes.md \
            --prerelease \
            artifacts/*.tar.gz \
            artifacts/*.md5 \
            artifacts/*.sha256
          
          echo "âœ… Test release created: $TEST_TAG"
          echo ""
          echo "ğŸ—‘ï¸ To delete: gh release delete $TEST_TAG --yes"
  
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # FINAL: TEST SUMMARY
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  test-summary:
    name: ğŸ“‹ Test Summary
    needs:
      - download-previous
      - scrape-steamspy
      - compress-data
      - validate-data
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ“Š Generate Summary
        run: |
          echo "# ğŸ§ª Test Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall status
          ALL_SUCCESS=true
          
          if [ "${{ needs.scrape-steamspy.result }}" != "success" ]; then
            ALL_SUCCESS=false
          fi
          
          if [ "${{ needs.compress-data.result }}" != "success" ]; then
            ALL_SUCCESS=false
          fi
          
          if [ "${{ needs.validate-data.result }}" != "success" ]; then
            ALL_SUCCESS=false
          fi
          
          if [ "$ALL_SUCCESS" == "true" ]; then
            echo "## âœ… ALL TESTS PASSED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The pipeline is working correctly!" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ TESTS FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "One or more pipeline stages failed." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Job results
          echo "## ğŸ“‹ Stage Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Download Previous | ${{ needs.download-previous.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Scrape (Test Mode) | ${{ needs.scrape-steamspy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Compress & Merge | ${{ needs.compress-data.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Validate | ${{ needs.validate-data.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Test configuration
          echo "## âš™ï¸ Test Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Pages Scraped:** 1 (test mode)" >> $GITHUB_STEP_SUMMARY
          echo "- **Expected Entries:** 1-1100" >> $GITHUB_STEP_SUMMARY
          echo "- **Fast Delays:** Enabled" >> $GITHUB_STEP_SUMMARY
          echo "- **Execution Time:** ~2-5 minutes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Statistics
          if [ "${{ needs.compress-data.outputs.total_entries }}" != "" ]; then
            echo "## ğŸ“Š Test Statistics" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Entries:** ${{ needs.compress-data.outputs.total_entries }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Archive Size:** ${{ needs.compress-data.outputs.archive_size }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ’¡ **Tip:** Run this test before deploying production changes" >> $GITHUB_STEP_SUMMARY
      
      - name: âœ… Test Success
        if: success()
        run: |
          echo "âœ… Test pipeline completed successfully!"
          echo "ğŸš€ Safe to run production pipeline"
      
      - name: âŒ Test Failure
        if: failure()
        run: |
          echo "âŒ Test pipeline failed!"
          echo "âš ï¸ Do not run production pipeline until tests pass"
          exit 1