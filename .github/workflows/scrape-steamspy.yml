name: üéÆ SteamSpy Scraper

on:
  workflow_call:
    inputs:
      pages:
        description: 'Pages to scrape (~1000 apps each)'
        default: "10"
        type: string
      page_delay:
        default: "15"
        type: string
      app_delay:
        default: "0.1"
        type: string
    outputs:
      games_scraped:
        value: ${{ jobs.scrape.outputs.total }}

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    outputs:
      total: ${{ steps.stats.outputs.count }}
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: Install UV
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      
      - name: Install dependencies
        run: uv sync
      
      - name: Run scraper
        id: scrape
        run: |
          cat > run_steamspy.py << 'EOF'
          import asyncio, sys
          sys.path.insert(0, '.')
          from src.FileSystem import FileSystem
          from src.SteamSpyScraper import SteamSpyScraper
          
          async def main():
              fs = FileSystem("Data", "SteamSpyScraper")
              async with SteamSpyScraper(
                  fs, 
                  pages=int(${{ inputs.pages }}),
                  page_delay=float(${{ inputs.page_delay }}),
                  app_delay=float(${{ inputs.app_delay }})
              ) as s:
                  return await s.scrape()
          
          try:
              total = asyncio.run(main())
              print(f"‚úì Scraped {total} games")
              with open("stats.txt", "w") as f:
                  f.write(str(total))
          except Exception as e:
              print(f"‚úó Scraper failed: {e}")
              with open("stats.txt", "w") as f:
                  f.write("0")
              exit(1)
          EOF
          
          uv run python run_steamspy.py
        continue-on-error: false
      
      - name: Calculate stats
        id: stats
        if: always()
        run: |
          if [ -f "stats.txt" ]; then
            COUNT=$(cat stats.txt)
            echo "count=$COUNT" >> $GITHUB_OUTPUT
            echo "üìä Scraped: $COUNT games"
          else
            echo "count=0" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è No stats file found"
          fi
      
      - name: Verify data exists
        run: |
          TODAY=$(date +%Y-%m-%d)
          DATA_DIR="Data/$TODAY/SteamSpyScraper"
          
          if [ ! -d "$DATA_DIR" ]; then
            echo "::error::Data directory not found: $DATA_DIR"
            exit 1
          fi
          
          JSONL="$DATA_DIR/steamspy_data.jsonl"
          if [ ! -f "$JSONL" ]; then
            echo "::error::Data file not found: $JSONL"
            exit 1
          fi
          
          LINES=$(wc -l < "$JSONL")
          if [ "$LINES" -eq 0 ]; then
            echo "::error::Data file is empty"
            exit 1
          fi
          
          echo "‚úì Found $LINES entries in $JSONL"
      
      - name: Upload data
        uses: actions/upload-artifact@v4
        with:
          name: steamspy-data-raw
          path: Data/
          retention-days: 1
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::SteamSpy scraper failed!"
          echo "::error::Check logs above for details"
          
          if [ -f "Data/**/steamspy_errors.log" ]; then
            echo "::group::Error Log"
            cat Data/**/steamspy_errors.log
            echo "::endgroup::"
          fi