name: ðŸŽ® SteamSpy Scraper

on:
  workflow_call:
    inputs:
      pages:
        description: 'Pages to scrape (~1000 apps each)'
        default: "10"
        type: string
      page_delay:
        default: "15"
        type: string
      app_delay:
        default: "0.1"
        type: string
    outputs:
      games_scraped:
        value: ${{ jobs.scrape.outputs.total }}

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    outputs:
      total: ${{ steps.stats.outputs.count }}
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: Install UV
        run: curl -LsSf https://astral.sh/uv/install.sh | sh
      
      - name: Install deps
        run: uv sync
      
      - name: Run scraper
        run: |
          cat > run_steamspy.py << 'EOF'
          import asyncio, sys
          sys.path.insert(0, '.')
          from src.FileSystem import FileSystem
          from src.SteamSpyScraper import SteamSpyScraper
          
          async def main():
              fs = FileSystem("Data", "SteamSpyScraper")
              async with SteamSpyScraper(
                  fs, 
                  pages=int("${{ inputs.pages || '10' }}"),
                  page_delay=float("${{ inputs.page_delay || '15' }}"),
                  app_delay=float("${{ inputs.app_delay || '0.1' }}"),
                  suppress_output=False  # ADD THIS LINE
              ) as s:
                  total = await s.scrape()
              print(f"âœ… Complete! total={total}")
              return total
          
          total = asyncio.run(main())
          with open("stats.txt", "w") as f:
              f.write(str(total))
          EOF
          
          uv run python run_steamspy.py
        id: scrape
        
      - name: Get stats
        id: stats
        run: |
          if [ -f "stats.txt" ]; then
            echo "count=$(cat stats.txt)" >> $GITHUB_OUTPUT
          else
            echo "count=0" >> $GITHUB_OUTPUT
          fi
            
            - uses: actions/upload-artifact@v4
              with:
                name: steamspy-data-raw
                path: Data/
                retention-days: 1