name: ðŸŽ® SteamSpy Scraper

on:
  workflow_call:
    inputs:
      pages:
        description: 'Pages to scrape (~1000 apps each)'
        default: "10"
        type: string
      page_delay:
        default: "15"
        type: string
      app_delay:
        default: "0.1"
        type: string
    outputs:
      games_scraped:
        value: ${{ jobs.scrape.outputs.total }}

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    outputs:
      total: ${{ steps.stats.outputs.count }}
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: Install UV
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      
      - name: Install dependencies
        run: uv sync
      
      - name: Run scraper
        id: scrape
        env:
          STEAMSPY_PAGES: ${{ inputs.pages }}
          STEAMSPY_PAGE_DELAY: ${{ inputs.page_delay }}
          STEAMSPY_APP_DELAY: ${{ inputs.app_delay }}
        run: |
          echo "Starting SteamSpy scraper..."
          uv run python -m src.SteamSpyScraper | tee output.txt
          
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "::error::Scraper script failed"
            cat output.txt
            exit 1
          fi
          
          # Extract count for output
          if grep -q "âœ“ Scraped" output.txt; then
            COUNT=$(grep "âœ“ Scraped" output.txt | grep -oP '\d+' | head -1)
            echo "$COUNT" > stats.txt
          else
            echo "0" > stats.txt
          fi
        continue-on-error: false
      
      - name: Calculate stats
        id: stats
        if: always()
        run: |
          if [ -f "stats.txt" ]; then
            COUNT=$(cat stats.txt)
            echo "count=$COUNT" >> $GITHUB_OUTPUT
            echo "ðŸ“Š Scraped: $COUNT games"
          else
            echo "count=0" >> $GITHUB_OUTPUT
            echo "âš ï¸ No stats file found"
          fi
      
      - name: Validate output
        run: |
          TODAY=$(date +%Y-%m-%d)
          DATA_DIR="Data/$TODAY/SteamSpyScraper"
          JSONL="$DATA_DIR/steamspy_data.jsonl"
          
          echo "Checking for output in: $DATA_DIR"
          ls -la "$DATA_DIR" || echo "Directory does not exist"
          
          if [ ! -f "$JSONL" ]; then
            echo "::error::Output file not found: $JSONL"
            echo "::error::Check scraper logs above for errors"
            exit 1
          fi
          
          if [ ! -s "$JSONL" ]; then
            echo "::error::Output file is empty: $JSONL"
            exit 1
          fi
          
          # Check for valid JSON (sample first 10 lines)
          if ! head -10 "$JSONL" | python -m json.tool >/dev/null 2>&1; then
            echo "::error::Invalid JSON detected in $JSONL"
            exit 1
          fi
          
          # Check minimum threshold
          LINES=$(wc -l < "$JSONL")
          if [ "$LINES" -lt 100 ]; then
            echo "::error::Only $LINES games scraped (expected >100)"
            exit 1
          fi
          
          echo "âœ“ Validation passed: $LINES valid entries"
      
      - name: Upload data
        uses: actions/upload-artifact@v4
        with:
          name: steamspy-data-raw
          path: Data/
          retention-days: 1
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::SteamSpy scraper failed!"
          echo "::error::Check logs above for details"
          
          if [ -f "Data/**/steamspy_errors.log" ]; then
            echo "::group::Error Log"
            cat Data/**/steamspy_errors.log
            echo "::endgroup::"
          fi