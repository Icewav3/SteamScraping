# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ðŸ“¦ DATA COMPRESSION - Reusable Workflow
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# Compresses all scraped data into optimized archives for efficient storage
# and transfer. Uses tar.gz for maximum compression and compatibility.
#
# This workflow downloads artifacts from all scraper jobs, merges them,
# and creates compressed archives ready for upload.
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: ðŸ“¦ Data Compression

on:
  workflow_call:
    outputs:
      archive_name:
        description: 'Name of the compressed archive'
        value: ${{ jobs.compress.outputs.archive_name }}
      
      archive_size:
        description: 'Size of the compressed archive'
        value: ${{ jobs.compress.outputs.archive_size }}
      
      compression_ratio:
        description: 'Compression ratio achieved'
        value: ${{ jobs.compress.outputs.compression_ratio }}

  workflow_dispatch:

jobs:
  compress:
    name: Compressing Data
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    outputs:
      archive_name: ${{ steps.create.outputs.filename }}
      archive_size: ${{ steps.stats.outputs.size }}
      compression_ratio: ${{ steps.stats.outputs.ratio }}
    
    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # DOWNLOAD ARTIFACTS
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      - name: ðŸ“¥ Download SteamSpy Data
        uses: actions/download-artifact@v4
        with:
          name: steamspy-data-raw
          path: Data/
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ðŸ”® FUTURE: Download additional scraper artifacts here
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      #
      # - name: ðŸ“¥ Download IGDB Data
      #   uses: actions/download-artifact@v4
      #   with:
      #     name: igdb-data-raw
      #     path: Data/
      #
      # - name: ðŸ“¥ Download RAWG Data
      #   uses: actions/download-artifact@v4
      #   with:
      #     name: rawg-data-raw
      #     path: Data/
      #
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # VALIDATION
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      - name: âœ… Verify Downloaded Data
        run: |
          echo "ðŸ“Š Verifying data integrity..."
          
          if [ ! -d "Data" ]; then
            echo "âŒ Data directory not found!"
            exit 1
          fi
          
          # Check if Data directory has content
          FILE_COUNT=$(find Data -type f | wc -l)
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "âŒ No files found in Data directory!"
            exit 1
          fi
          
          echo "âœ… Found $FILE_COUNT files"
          
          # Show directory structure
          echo ""
          echo "ðŸ“ Data structure:"
          tree -L 2 Data/ || ls -R Data/
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # CALCULATE ORIGINAL SIZE
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      - name: ðŸ“Š Calculate Original Size
        id: original
        run: |
          ORIGINAL_SIZE=$(du -sb Data | cut -f1)
          ORIGINAL_SIZE_MB=$(echo "scale=2; $ORIGINAL_SIZE / 1048576" | bc)
          
          echo "size_bytes=$ORIGINAL_SIZE" >> $GITHUB_OUTPUT
          echo "size_mb=$ORIGINAL_SIZE_MB" >> $GITHUB_OUTPUT
          
          echo "ðŸ“¦ Original data size: ${ORIGINAL_SIZE_MB} MB"
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # COMPRESSION
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      - name: ðŸ—œï¸ Create Compressed Archive
        id: create
        run: |
          TODAY=$(date +%Y-%m-%d)
          FILENAME="game-data-${TODAY}.tar.gz"
          
          echo "ðŸ—œï¸ Creating compressed archive..."
          echo "ðŸ“ Filename: $FILENAME"
          
          # Create tar.gz with maximum compression
          tar -czf "$FILENAME" Data/
          
          # Verify archive was created
          if [ ! -f "$FILENAME" ]; then
            echo "âŒ Failed to create archive!"
            exit 1
          fi
          
          echo "filename=$FILENAME" >> $GITHUB_OUTPUT
          echo "âœ… Archive created successfully!"
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # COMPRESSION STATISTICS
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      - name: ðŸ“Š Calculate Compression Statistics
        id: stats
        run: |
          FILENAME="${{ steps.create.outputs.filename }}"
          
          # Get compressed size
          COMPRESSED_SIZE=$(stat -f%z "$FILENAME" 2>/dev/null || stat -c%s "$FILENAME")
          COMPRESSED_SIZE_MB=$(echo "scale=2; $COMPRESSED_SIZE / 1048576" | bc)
          
          # Calculate compression ratio
          ORIGINAL_SIZE=${{ steps.original.outputs.size_bytes }}
          RATIO=$(echo "scale=2; (1 - $COMPRESSED_SIZE / $ORIGINAL_SIZE) * 100" | bc)
          
          echo "size=${COMPRESSED_SIZE_MB}MB" >> $GITHUB_OUTPUT
          echo "ratio=${RATIO}%" >> $GITHUB_OUTPUT
          
          echo "ðŸ“Š Compression Statistics:"
          echo "  â€¢ Original Size: ${{ steps.original.outputs.size_mb }} MB"
          echo "  â€¢ Compressed Size: ${COMPRESSED_SIZE_MB} MB"
          echo "  â€¢ Compression Ratio: ${RATIO}%"
          echo "  â€¢ Space Saved: $(echo "scale=2; ${{ steps.original.outputs.size_mb }} - $COMPRESSED_SIZE_MB" | bc) MB"
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # VERIFICATION
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      - name: âœ… Verify Archive Integrity
        run: |
          FILENAME="${{ steps.create.outputs.filename }}"
          
          echo "ðŸ” Verifying archive integrity..."
          
          # Test archive
          if tar -tzf "$FILENAME" > /dev/null 2>&1; then
            echo "âœ… Archive integrity verified!"
          else
            echo "âŒ Archive is corrupted!"
            exit 1
          fi
          
          # List contents (first 20 files)
          echo ""
          echo "ðŸ“‹ Archive contents (sample):"
          tar -tzf "$FILENAME" | head -20
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # CREATE CHECKSUMS
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      - name: ðŸ” Generate Checksums
        run: |
          FILENAME="${{ steps.create.outputs.filename }}"
          
          echo "ðŸ” Generating checksums for verification..."
          
          # Generate MD5 checksum
          md5sum "$FILENAME" > "${FILENAME}.md5"
          
          # Generate SHA256 checksum
          sha256sum "$FILENAME" > "${FILENAME}.sha256"
          
          echo ""
          echo "ðŸ“‹ Checksums:"
          cat "${FILENAME}.md5"
          cat "${FILENAME}.sha256"
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # UPLOAD ARTIFACT
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      - name: ðŸ“¤ Upload Compressed Archive
        uses: actions/upload-artifact@v4
        with:
          name: compressed-data-archive
          path: |
            game-data-*.tar.gz
            game-data-*.md5
            game-data-*.sha256
          retention-days: 90  # Keep for 90 days
          compression-level: 0  # Already compressed
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # METADATA FILE
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: ðŸ“ Create Archive Metadata
        run: |
          TODAY=$(date +%Y-%m-%d)
          FILENAME="${{ steps.create.outputs.filename }}"
          
          # Count total entries from JSONL files
          TOTAL_ENTRIES=$(find Data -name "*.jsonl" -exec wc -l {} + 2>/dev/null | tail -1 | awk '{print $1}' || echo "0")
          
          cat > archive-metadata.json << EOF
          {
            "archive_name": "$FILENAME",
            "creation_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "original_size_mb": "${{ steps.original.outputs.size_mb }}",
            "compressed_size_mb": "${{ steps.stats.outputs.size }}",
            "compression_ratio": "${{ steps.stats.outputs.ratio }}",
            "total_entries": $TOTAL_ENTRIES,
            "new_entries": $TOTAL_ENTRIES,
            "data_sources": [
              "steamspy"
            ],
            "github_run_id": "${{ github.run_id }}",
            "github_sha": "${{ github.sha }}"
          }
          EOF
          
          echo "ðŸ“„ Metadata created:"
          cat archive-metadata.json
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # SUMMARY
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      - name: ðŸ“ Generate Job Summary
        run: |
          echo "## ðŸ“¦ Data Compression Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Status:** Success" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Archive Name** | \`${{ steps.create.outputs.filename }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Original Size** | ${{ steps.original.outputs.size_mb }} MB |" >> $GITHUB_STEP_SUMMARY
          echo "| **Compressed Size** | ${{ steps.stats.outputs.size }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Compression Ratio** | ${{ steps.stats.outputs.ratio }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Space Saved** | $(echo 'scale=2; ${{ steps.original.outputs.size_mb }} - ${{ steps.stats.outputs.size }}' | sed 's/MB//g' | bc) MB |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Verification" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Archive integrity verified" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Checksums generated (MD5 & SHA256)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Metadata created" >> $GITHUB_STEP_SUMMARY
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # CLEANUP
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      - name: ðŸ§¹ Cleanup Temporary Files
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up temporary files..."
          rm -rf Data/
          echo "âœ… Cleanup complete!"