name: ðŸ“¦ Merge & Release

on:
  workflow_call:

jobs:
  merge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download cumulative dataset
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LATEST=$(gh release list --limit 1 --json tagName -q '.[0].tagName' 2>/dev/null || echo "")
          
          if [ -n "$LATEST" ] && gh release download "$LATEST" -p "gamedata-*.tar.gz" 2>/dev/null; then
            tar -xzf gamedata-*.tar.gz && rm gamedata-*.tar.gz
            echo "âœ“ Restored cumulative dataset: $LATEST"
          else
            echo "âš  No previous release, starting fresh"
          fi
      
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./new-data/
      
      - name: Merge new data
        run: |
          for artifact in ./new-data/*/Data; do
            [ -d "$artifact" ] && cp -rn "$artifact"/* Data/ 2>/dev/null || true
          done
          
          echo "âœ“ Dataset contains $(find Data -type d -name '????-??-??' | wc -l) dates"
      
      - name: Create release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="data-$(date +%Y-%m-%d)"
          ARCHIVE="gamedata-${TAG}.tar.gz"
          
          tar -czf "$ARCHIVE" Data/
          
          gh release view "$TAG" &>/dev/null && gh release delete "$TAG" -y --cleanup-tag
          
          gh release create "$TAG" "$ARCHIVE" \
            --title "Game Data - $(date +%Y-%m-%d)" \
            --notes "Cumulative dataset: $(find Data -type d -name '????-??-??' | wc -l) dates, $(du -h "$ARCHIVE" | cut -f1)"