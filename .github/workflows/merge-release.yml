name: ðŸ“¦ Merge & Release

on:
  workflow_call:

jobs:
  merge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./new-data/
      
      - name: Download previous release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG=$(gh release list --limit 1 | grep "^data-" | awk '{print $1}')
          if [ -n "$TAG" ]; then
            echo "Downloading $TAG..."
            gh release download "$TAG" --pattern "*.tar.gz"
            tar -xzf *.tar.gz
            rm *.tar.gz
          fi
            
      - name: Merge data
        run: |
          # Copy new scraper data into cumulative Data/ structure
          if [ -d "./new-data/steamspy-data-raw" ]; then
            TODAY=$(date +%Y-%m-%d)
            mkdir -p "Data/$TODAY/SteamSpyScraper"
            cp -r ./new-data/steamspy-data-raw/$TODAY/SteamSpyScraper/* "Data/$TODAY/SteamSpyScraper/" || true
          fi
          
          # IGDB
          if [ -d "./new-data/igdb-data" ]; then
            TODAY=$(date +%Y-%m-%d)
            mkdir -p "Data/$TODAY/IGDBScraper"
            cp -r ./new-data/igdb-data/$TODAY/IGDBScraper/* "Data/$TODAY/IGDBScraper/" || true
          fi

          # RAWG
          if [ -d "./new-data/rawg-data" ]; then
            TODAY=$(date +%Y-%m-%d)
            mkdir -p "Data/$TODAY/RAWGScraper"
            cp -r ./new-data/rawg-data/$TODAY/RAWGScraper/* "Data/$TODAY/RAWGScraper/" || true
          fi
          
          echo "âœ“ Merged structure:"
          tree Data/ -L 3 || ls -R Data/
      
      - name: Create release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="data-$(date +%Y-%m-%d)"
          ARCHIVE="gamedata-${TAG}.tar.gz"
          
          tar -czf "$ARCHIVE" Data/
          
          gh release create "$TAG" "$ARCHIVE" \
            --title "Game Data - $(date +%Y-%m-%d)" \
            --notes "Cumulative dataset with all historical data" \
            || gh release upload "$TAG" "$ARCHIVE" --clobber