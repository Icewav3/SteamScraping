name: ðŸ“¦ Merge & Release

on:
  workflow_call:

jobs:
  merge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./new-data/
      
      - name: Download previous release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          YESTERDAY=$(date -d "yesterday" +%Y-%m-%d 2>/dev/null || date -v-1d +%Y-%m-%d)
          TAG="data-${YESTERDAY}"
          
          echo "Looking for previous release: $TAG"
          
          # Only download if it exists
          if gh release view "$TAG" &>/dev/null; then
            echo "âœ“ Downloading $TAG..."
            gh release download "$TAG" --pattern "*.tar.gz"
            tar -xzf *.tar.gz
            rm *.tar.gz
          else
            echo "âš  No previous release found, starting fresh cumulative dataset"
          fi
            
      - name: Merge data
        run: |
          echo "Merging available data sources..."
          TODAY=$(date +%Y-%m-%d)
          
          # Copy new scraper data into cumulative Data/ structure
          # Only merge what actually exists (allows partial scraper failures)
          
          if [ -d "./new-data/steamspy-data-raw" ]; then
            echo "âœ“ Found SteamSpy data"
            mkdir -p "Data/$TODAY/SteamSpyScraper"
            cp -r ./new-data/steamspy-data-raw/$TODAY/SteamSpyScraper/* "Data/$TODAY/SteamSpyScraper/" || true
          else
            echo "âš  Missing SteamSpy data (scraper may have failed)"
          fi
          
          if [ -d "./new-data/igdb-data" ]; then
            echo "âœ“ Found IGDB data"
            mkdir -p "Data/$TODAY/IGDBScraper"
            cp -r ./new-data/igdb-data/$TODAY/IGDBScraper/* "Data/$TODAY/IGDBScraper/" || true
          else
            echo "âš  Missing IGDB data (scraper may have failed)"
          fi

          if [ -d "./new-data/rawg-data" ]; then
            echo "âœ“ Found RAWG data"
            mkdir -p "Data/$TODAY/RAWGScraper"
            cp -r ./new-data/rawg-data/$TODAY/RAWGScraper/* "Data/$TODAY/RAWGScraper/" || true
          else
            echo "âš  Missing RAWG data (scraper may have failed)"
          fi
          
          echo ""
          echo "âœ“ Merged structure:"
          tree Data/ -L 3 || ls -R Data/
      
      - name: Create release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="data-$(date +%Y-%m-%d)"
          ARCHIVE="gamedata-${TAG}.tar.gz"
          
          tar -czf "$ARCHIVE" Data/
          
          if gh release view "$TAG" &>/dev/null; then
            echo "âš  Release $TAG already exists, deleting for rerun..."
            gh release delete "$TAG" --yes
          fi
          
          gh release create "$TAG" "$ARCHIVE" \
            --title "Game Data - $(date +%Y-%m-%d)" \
            --notes "Cumulative dataset with all historical data"