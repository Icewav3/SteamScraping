# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ðŸ“¥ DOWNLOAD PREVIOUS RELEASE DATA - Reusable Workflow
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# Downloads the most recent release archive, extracts it, and prepares it
# for merging with newly scraped data. This ensures historical data persistence.
#
# Key Features:
# - Automatically finds latest release
# - Validates archive integrity
# - Extracts to staging directory
# - Reports statistics for comparison
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: ðŸ“¥ Download Previous Data

on:
  workflow_call:
    outputs:
      has_previous_data:
        description: 'Whether previous data was found and extracted'
        value: ${{ jobs.download.outputs.has_data }}
      
      previous_file_count:
        description: 'Number of files in previous archive'
        value: ${{ jobs.download.outputs.file_count }}
      
      previous_size_mb:
        description: 'Size of previous data in MB'
        value: ${{ jobs.download.outputs.size_mb }}

  workflow_dispatch:

jobs:
  download:
    name: Downloading Previous Release
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    outputs:
      has_data: ${{ steps.check.outputs.exists }}
      file_count: ${{ steps.stats.outputs.files }}
      size_mb: ${{ steps.stats.outputs.size }}
    
    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # SETUP
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # FIND LATEST RELEASE
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      - name: ðŸ” Find Latest Release
        id: find
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ðŸ” Searching for latest data release..."
          
          # Get the most recent release with tag starting with "data-"
          LATEST_TAG=$(gh release list --limit 100 | grep "^data-" | head -1 | awk '{print $1}')
          
          if [ -z "$LATEST_TAG" ]; then
            echo "âš ï¸ No previous releases found"
            echo "tag=" >> $GITHUB_OUTPUT
            echo "found=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "âœ… Found release: $LATEST_TAG"
          echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "found=true" >> $GITHUB_OUTPUT
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # DOWNLOAD ARCHIVE
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      - name: ðŸ“¥ Download Archive
        if: steps.find.outputs.found == 'true'
        id: download
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ steps.find.outputs.tag }}"
          
          echo "ðŸ“¥ Downloading archive from release: $TAG"
          
          # Download all assets from the release
          gh release download "$TAG" --pattern "*.tar.gz" --dir ./previous/
          
          # Find the downloaded archive
          ARCHIVE=$(find ./previous -name "*.tar.gz" | head -1)
          
          if [ -z "$ARCHIVE" ]; then
            echo "âŒ No archive found in release!"
            exit 1
          fi
          
          echo "archive=$ARCHIVE" >> $GITHUB_OUTPUT
          echo "âœ… Downloaded: $(basename $ARCHIVE)"
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # VERIFY CHECKSUMS
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      - name: ðŸ” Verify Archive Integrity
        if: steps.find.outputs.found == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ steps.find.outputs.tag }}"
          ARCHIVE="${{ steps.download.outputs.archive }}"
          
          echo "ðŸ” Verifying archive integrity..."
          
          # Download checksum files
          gh release download "$TAG" --pattern "*.sha256" --dir ./previous/
          
          # Find checksum file
          CHECKSUM_FILE=$(find ./previous -name "*.sha256" | head -1)
          
          if [ -z "$CHECKSUM_FILE" ]; then
            echo "âš ï¸ No checksum file found - skipping verification"
            exit 0
          fi
          
          # Verify checksum
          cd ./previous
          if sha256sum -c "$(basename $CHECKSUM_FILE)" 2>/dev/null; then
            echo "âœ… Archive integrity verified!"
          else
            echo "âŒ Checksum verification failed!"
            exit 1
          fi
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # EXTRACT ARCHIVE
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      - name: ðŸ“¦ Extract Previous Data
        if: steps.find.outputs.found == 'true'
        run: |
          ARCHIVE="${{ steps.download.outputs.archive }}"
          
          echo "ðŸ“¦ Extracting archive..."
          
          # Extract to Data_Previous directory
          mkdir -p Data_Previous
          tar -xzf "$ARCHIVE" -C Data_Previous --strip-components=1
          
          # Verify extraction
          if [ ! -d "Data_Previous" ] || [ -z "$(ls -A Data_Previous)" ]; then
            echo "âŒ Extraction failed or directory is empty!"
            exit 1
          fi
          
          echo "âœ… Extraction complete!"
          
          # Show directory structure
          echo ""
          echo "ðŸ“ Previous data structure:"
          tree -L 2 Data_Previous/ 2>/dev/null || ls -R Data_Previous/ | head -50
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # CALCULATE STATISTICS
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      - name: ðŸ“Š Calculate Previous Data Statistics
        if: steps.find.outputs.found == 'true'
        id: stats
        run: |
          echo "ðŸ“Š Analyzing previous data..."
          
          # Count files
          FILE_COUNT=$(find Data_Previous -type f -name "*.jsonl" | wc -l)
          
          # Count total entries (lines in JSONL files)
          TOTAL_ENTRIES=0
          for file in $(find Data_Previous -type f -name "*.jsonl"); do
            ENTRIES=$(wc -l < "$file")
            TOTAL_ENTRIES=$((TOTAL_ENTRIES + ENTRIES))
          done
          
          # Calculate size
          SIZE_BYTES=$(du -sb Data_Previous | cut -f1)
          SIZE_MB=$(echo "scale=2; $SIZE_BYTES / 1048576" | bc)
          
          echo "files=$FILE_COUNT" >> $GITHUB_OUTPUT
          echo "entries=$TOTAL_ENTRIES" >> $GITHUB_OUTPUT
          echo "size=$SIZE_MB" >> $GITHUB_OUTPUT
          
          echo "ðŸ“Š Previous Data Statistics:"
          echo "  â€¢ JSONL Files: $FILE_COUNT"
          echo "  â€¢ Total Entries: $TOTAL_ENTRIES"
          echo "  â€¢ Size: ${SIZE_MB} MB"
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # CHECK IF DATA EXISTS
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      - name: âœ… Verify Data Availability
        id: check
        run: |
          if [ -d "Data_Previous" ] && [ -n "$(ls -A Data_Previous)" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Previous data is available for merging"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No previous data found - will create new archive"
          fi
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # UPLOAD AS ARTIFACT
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      - name: ðŸ“¤ Upload Previous Data
        if: steps.check.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: previous-data
          path: Data_Previous/
          retention-days: 1  # Only needed for this workflow run
          compression-level: 0  # Already compressed
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # SUMMARY
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      - name: ðŸ“ Generate Job Summary
        if: always()
        run: |
          echo "## ðŸ“¥ Previous Data Download Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.find.outputs.found }}" == "true" ]; then
            echo "âœ… **Status:** Success" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“Š Statistics" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| **Release Tag** | \`${{ steps.find.outputs.tag }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **JSONL Files** | ${{ steps.stats.outputs.files }} |" >> $GITHUB_STEP_SUMMARY
            echo "| **Total Entries** | ${{ steps.stats.outputs.entries }} |" >> $GITHUB_STEP_SUMMARY
            echo "| **Size** | ${{ steps.stats.outputs.size }} MB |" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **Status:** No Previous Data" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This appears to be the first run. A new archive will be created." >> $GITHUB_STEP_SUMMARY
          fi