name: ðŸŽ® RAWG Scraper

on:
  workflow_call:
    outputs:
      games_scraped:
        value: ${{ jobs.scrape.outputs.total }}

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    outputs:
      total: ${{ steps.stats.outputs.count }}
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: Install UV
        run: curl -LsSf https://astral.sh/uv/install.sh | sh
      
      - name: Install deps
        run: uv sync
      
      - name: Run scraper
        env:
          RAWG_API_KEY: ${{ secrets.RAWG_API_KEY }}
          RAWG_PAGES: "100"
        run: |
          # Use dedicated script instead of heredoc
          uv run python src/actions/run_rawg.py | tee output.txt
          echo "count=$(grep 'total=' output.txt | cut -d= -f2)" >> $GITHUB_OUTPUT
        id: stats
      
      - name: Validate output
        run: |
          TODAY=$(date +%Y-%m-%d)
          JSONL="Data/$TODAY/RAWGScraper/rawg_data.jsonl"
          
          # Check file exists and has content
          if [ ! -s "$JSONL" ]; then
            echo "::error::Output file missing or empty: $JSONL"
            exit 1
          fi
          
          # Check for valid JSON (sample first 10 lines)
          if ! head -10 "$JSONL" | python -m json.tool >/dev/null 2>&1; then
            echo "::error::Invalid JSON detected in $JSONL"
            exit 1
          fi
          
          # Check minimum threshold
          LINES=$(wc -l < "$JSONL")
          if [ "$LINES" -lt 50 ]; then
            echo "::error::Only $LINES games scraped (expected >50)"
            exit 1
          fi
          
          echo "âœ“ Validation passed: $LINES valid entries"
      
      - uses: actions/upload-artifact@v4
        with:
          name: rawg-data
          path: Data/
          retention-days: 1