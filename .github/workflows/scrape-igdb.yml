name: ðŸŽ® IGDB Scraper

on:
  workflow_call:
    outputs:
      games_scraped:
        value: ${{ jobs.scrape.outputs.total }}
      has_warnings:
        value: ${{ jobs.scrape.outputs.warnings }}

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    outputs:
      total: ${{ steps.stats.outputs.count }}
      warnings: ${{ steps.health.outputs.warnings }}
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: Install UV
        run: curl -LsSf https://astral.sh/uv/install.sh | sh
      
      - name: Install deps
        run: uv sync
      
      - name: Run scraper
        env:
          IGDB_CLIENT_ID: ${{ secrets.IGDB_CLIENT_ID }}
          IGDB_CLIENT_SECRET: ${{ secrets.IGDB_CLIENT_SECRET }}
          IGDB_PAGES: "50"
        run: uv run python actions/run_igdb.py 2>&1 | tee output.txt || true
      
      - name: Extract stats
        id: stats
        if: always()
        run: |
          COUNT=$(grep -oP '(?<=total=)\d+' output.txt 2>/dev/null || echo "0")
          echo "count=$COUNT" >> $GITHUB_OUTPUT
      
      - name: Health check
        id: health
        if: always()
        run: |
          JSONL="Data/$(date +%Y-%m-%d)/IGDBScraper/igdb_data.jsonl"
          WARNINGS=""
          
          if [ ! -s "$JSONL" ]; then
            WARNINGS="Missing or empty output. "
            echo "::warning::$WARNINGS"
          else
            python -c "import json; [json.loads(l) for l in open('$JSONL')]" 2>/dev/null || {
              WARNINGS="${WARNINGS}Invalid JSON. "
              echo "::warning::Invalid JSON detected"
            }
            
            LINES=$(wc -l < "$JSONL")
            [ "$LINES" -lt 50 ] && {
              WARNINGS="${WARNINGS}Low count ($LINES < 50). "
              echo "::warning::Only $LINES games scraped"
            }
          fi
          
          echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT
          exit 0
      
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: igdb-data
          path: Data/
          retention-days: 1